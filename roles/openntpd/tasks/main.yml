---
- name: Remove other implementations of ntp
  xbps: pkg={{ item }} state=absent
  with_items:
    - ntp
    - chrony

- name: Install openntpd
  xbps: pkg=openntpd state=present

- name: Configure openntpd
  template: src=ntpd.conf.j2 dest=/etc/ntpd.conf owner=root group=root mode=0644 validate="ntpd -nf %s"
  notify:
    - ntpd

- name: Check for presence of iptables.d
  stat: path=/etc/iptables.d
  register: iptables_d_present

- name: Install openntpd rules
  template: src=ntpd.rules.j2 dest=/etc/iptables.d/ntpd.rules owner=root group=root mode=0644
  notify:
    - iptables

- name: Enable openntpd at startup
  file: src=/etc/sv/ntpd dest=/var/service/ntpd state=link
  notify:
    - ntpd
